// frontend/src/components/ChatPanel.tsx
import { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import './ChatPanel.css';

interface ChatPanelProps {
  isOpen: boolean;
  onClose: () => void;
  polygon: Array<{ lat: number; lng: number }>;
  activeLayers: Record<string, string>;
  geojsonLayerData: any;
  startDate: string;
  endDate: string;
}

interface Message {
  id: string;
  text: string;
  sender: 'user' | 'jatai';
  timestamp: Date;
}

export default function ChatPanel({ isOpen, onClose, polygon, activeLayers, geojsonLayerData, startDate, endDate }: ChatPanelProps) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputValue, setInputValue] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [showBeeAnimation, setShowBeeAnimation] = useState(false);
  const [animationPhase, setAnimationPhase] = useState<'bee' | 'morph' | 'panel'>('bee');
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  const API_BASE = (import.meta as any).env.VITE_API_URL || "http://127.0.0.1:8000";

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    if (isOpen) {
      // Iniciar anima√ß√£o da abelha
      setShowBeeAnimation(true);
      setAnimationPhase('bee');
      
      // Ap√≥s 1s, transformar em logo
      setTimeout(() => setAnimationPhase('morph'), 1000);
      
      // Ap√≥s 1.8s, abrir painel
      setTimeout(() => {
        setAnimationPhase('panel');
        if (inputRef.current) {
          inputRef.current.focus();
        }
      }, 1800);
    } else {
      setShowBeeAnimation(false);
      setAnimationPhase('bee');
    }
  }, [isOpen]);

  // Carregar contexto inicial quando abrir o chat
  useEffect(() => {
    if (isOpen && messages.length === 0 && animationPhase === 'panel') {
      loadInitialContext();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen]);

  const loadInitialContext = async () => {
    setIsLoading(true);
    try {
      const contextData = {
        polygon: polygon.length >= 3 ? polygon : null,
        satellite_layers: activeLayers,
        geojson_data: geojsonLayerData,
        start_date: startDate,
        end_date: endDate,
        metadata: {
          layers_count: Object.keys(activeLayers).length,
          has_polygon: polygon.length >= 3
        }
      };

      const response = await fetch(`${API_BASE}/api/agent/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: "Ol√°! Me apresente resumindo o que voc√™ v√™ no contexto atual (√°rea, datas, camadas, GeoJSON). Seja breve e mostre que tem acesso aos dados.",
          context_data: contextData
        })
      });

      if (!response.ok) {
        throw new Error(`Erro ${response.status}`);
      }

      const data = await response.json();

      const welcomeMessage: Message = {
        id: '1',
        text: data.response,
        sender: 'jatai',
        timestamp: new Date()
      };

      setMessages([welcomeMessage]);
    } catch (error) {
      const errorMessage: Message = {
        id: '1',
        text: 'üëã E a√≠! Sou o JAT-AI ü¶Ö, teu copiloto ambiental paraense. Bora conversar sobre a tua √°rea de estudo?',
        sender: 'jatai',
        timestamp: new Date()
      };
      setMessages([errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  const sendMessage = async () => {
    if (!inputValue.trim() || isLoading) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      text: inputValue,
      sender: 'user',
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputValue('');
    setIsLoading(true);

    try {
      // Preparar contexto
      const contextData = {
        polygon: polygon.length >= 3 ? polygon : null,
        satellite_layers: activeLayers,
        geojson_data: geojsonLayerData,
        start_date: startDate,
        end_date: endDate,
        metadata: {
          layers_count: Object.keys(activeLayers).length,
          has_polygon: polygon.length >= 3
        }
      };

      const response = await fetch(`${API_BASE}/api/agent/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: inputValue,
          context_data: contextData
        })
      });

      if (!response.ok) {
        throw new Error(`Erro ${response.status}: ${await response.text()}`);
      }

      const data = await response.json();

      const jataiMessage: Message = {
        id: (Date.now() + 1).toString(),
        text: data.response,
        sender: 'jatai',
        timestamp: new Date()
      };

      setMessages(prev => [...prev, jataiMessage]);
    } catch (error: any) {
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        text: `‚ùå Erro ao processar mensagem: ${error.message || error}`,
        sender: 'jatai',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  if (!isOpen) return null;

  return (
    <div className="chat-panel-overlay" onClick={onClose}>
      <AnimatePresence mode="wait">
        {/* Fase 1: Abelha voando */}
        {showBeeAnimation && animationPhase === 'bee' && (
          <motion.div
            key="bee"
            className="jatai-bee-animation"
            initial={{ 
              x: -100, 
              y: window.innerHeight / 2,
              scale: 0.3,
              rotate: -20
            }}
            animate={{ 
              x: window.innerWidth / 2 - 50,
              y: window.innerHeight / 2 - 50,
              scale: 1.5,
              rotate: [0, 10, -10, 0],
            }}
            exit={{ opacity: 0 }}
            transition={{ 
              duration: 1,
              ease: "easeInOut",
              rotate: {
                duration: 0.5,
                repeat: Infinity,
                ease: "easeInOut"
              }
            }}
          >
            <img src="/images/jatai-logo.png" alt="JATA√ç" className="jatai-bee-img" />
            {/* Asas batendo */}
            <motion.div 
              className="bee-wings"
              animate={{ 
                scaleX: [1, 1.3, 1],
                opacity: [0.6, 0.9, 0.6]
              }}
              transition={{ 
                duration: 0.15,
                repeat: Infinity,
                ease: "easeInOut"
              }}
            />
          </motion.div>
        )}

        {/* Fase 2: Transforma√ß√£o em logo */}
        {showBeeAnimation && animationPhase === 'morph' && (
          <motion.div
            key="morph"
            className="jatai-logo-morph"
            initial={{ 
              scale: 1.5,
              rotate: 0
            }}
            animate={{ 
              scale: 1,
              rotate: 360
            }}
            transition={{ 
              duration: 0.8,
              ease: "easeOut"
            }}
          >
            <img src="/images/jatai-logo.png" alt="JATA√ç" className="jatai-logo-img" />
          </motion.div>
        )}

        {/* Fase 3: Painel abrindo a partir da logo */}
        {animationPhase === 'panel' && (
          <motion.div 
            key="panel"
            className="chat-panel" 
            onClick={(e) => e.stopPropagation()}
            initial={{ 
              scale: 0,
              opacity: 0,
              borderRadius: '50%'
            }}
            animate={{ 
              scale: 1,
              opacity: 1,
              borderRadius: '24px'
            }}
            exit={{ 
              scale: 0,
              opacity: 0,
              borderRadius: '50%'
            }}
            transition={{ 
              duration: 0.6,
              ease: [0.16, 1, 0.3, 1]
            }}
          >
        <div className="chat-header">
          <div className="chat-header-title">
            <div className="jatai-avatar">ü¶Ö</div>
            <div>
              <h2>JAT-AI</h2>
              <p className="chat-status">
                <span className="status-dot"></span>
                Online
              </p>
            </div>
          </div>
          <button className="chat-close-btn" onClick={onClose}>‚úï</button>
        </div>

        <div className="chat-messages">
          {messages.map((msg) => (
            <div key={msg.id} className={`message message-${msg.sender}`}>
              {msg.sender === 'jatai' && <div className="message-avatar">ü¶Ö</div>}
              <div className="message-content">
                <div className="message-text" dangerouslySetInnerHTML={{ 
                  __html: msg.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br/>')
                }} />
                <div className="message-time">
                  {msg.timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
              {msg.sender === 'user' && <div className="message-avatar user-avatar">üë§</div>}
            </div>
          ))}
          {isLoading && (
            <div className="message message-jatai">
              <div className="message-avatar">ü¶Ö</div>
              <div className="message-content">
                <div className="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        <div className="chat-input-container">
          <input
            ref={inputRef}
            type="text"
            className="chat-input"
            placeholder="Digite sua pergunta sobre a √°rea..."
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyPress={handleKeyPress}
            disabled={isLoading}
          />
          <button 
            className="chat-send-btn" 
            onClick={sendMessage}
            disabled={isLoading || !inputValue.trim()}
          >
            {isLoading ? '‚è≥' : 'üì§'}
          </button>
        </div>
      </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
